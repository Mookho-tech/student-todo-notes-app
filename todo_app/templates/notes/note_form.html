{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - TaskFlow{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'note_list' %}">Notes</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm animate-fade-in">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">{{ title }}</h2>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoSaveToggle" checked>
                        <label class="form-check-label" for="autoSaveToggle">Auto-save</label>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="noteForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                <i class="bi bi-type me-1"></i> Title
                            </label>
                            {{ form.title.errors }}
                            {{ form.title }}
                            <div class="form-text">A descriptive title for your note</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.content.id_for_label }}" class="form-label">
                                <i class="bi bi-text-paragraph me-1"></i> Content
                            </label>
                            {{ form.content.errors }}
                            {{ form.content }}
                            <div class="form-text d-flex justify-content-between">
                                <span id="wordCount">0</span> words, <span id="charCount">0</span> characters
                                <span id="saveStatus" class="text-success"></span>
                            </div>
                        </div>
                        
                        <!-- Tags Section -->
                        <div class="mb-3">
                            <label for="noteTags" class="form-label">
                                <i class="bi bi-tags me-1"></i> Tags
                            </label>
                            <input type="text" class="form-control" id="noteTags" placeholder="Add tags separated by commas">
                            <div class="form-text">Add tags to organize your notes</div>
                            <div id="tagsList" class="mt-2"></div>
                        </div>
                        
                        <!-- Formatting Toolbar -->
                        <div class="mb-3">
                            <div class="btn-toolbar" role="toolbar">
                                <div class="btn-group me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')">
                                        <i class="bi bi-type-underline"></i>
                                    </button>
                                </div>
                                <div class="btn-group me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('insertUnorderedList')">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('insertOrderedList')">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                </div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertLink()">
                                        <i class="bi bi-link-45deg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'note_list' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i> Cancel
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="saveDraft()">
                                    <i class="bi bi-save me-1"></i> Save Draft
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-1"></i> Save Note
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Writing Tips -->
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightbulb me-1"></i> Writing Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Structure</h6>
                            <ul class="small">
                                <li>Start with a clear heading</li>
                                <li>Use bullet points for lists</li>
                                <li>Break content into paragraphs</li>
                                <li>Include a summary at the end</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Best Practices</h6>
                            <ul class="small">
                                <li>Keep sentences concise</li>
                                <li>Use simple language</li>
                                <li>Include examples when possible</li>
                                <li>Review for clarity before saving</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Recent Notes -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-1"></i> Recent Notes
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_notes %}
                        <div class="list-group list-group-flush">
                            {% for recent_note in recent_notes %}
                                <a href="{% url 'note_detail' recent_note.id %}" class="list-group-item list-group-item-action">
                                    <h6 class="mb-1">{{ recent_note.title|truncatechars:30 }}</h6>
                                    <small class="text-muted">{{ recent_note.updated_at|date:"M d, Y" }}</small>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">No recent notes</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Shortcuts -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-keyboard me-1"></i> Shortcuts
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Bold</span>
                            <kbd>Ctrl + B</kbd>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Italic</span>
                            <kbd>Ctrl + I</kbd>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Underline</span>
                            <kbd>Ctrl + U</kbd>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Save</span>
                            <kbd>Ctrl + S</kbd>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contentField = document.getElementById('{{ form.content.id_for_label }}');
        const wordCount = document.getElementById('wordCount');
        const charCount = document.getElementById('charCount');
        const saveStatus = document.getElementById('saveStatus');
        const autoSaveToggle = document.getElementById('autoSaveToggle');
        const titleField = document.getElementById('{{ form.title.id_for_label }}');
        const tagsField = document.getElementById('noteTags');
        const tagsList = document.getElementById('tagsList');
        
        // Make content field a rich text editor
        contentField.contentEditable = true;
        contentField.style.minHeight = '300px';
        contentField.style.padding = '10px';
        contentField.style.border = '1px solid #ced4da';
        contentField.style.borderRadius = '0.375rem';
        
        // Create a hidden field to store the content
        const hiddenContentField = document.createElement('input');
        hiddenContentField.type = 'hidden';
        hiddenContentField.name = contentField.name;
        contentField.parentNode.insertBefore(hiddenContentField, contentField.nextSibling);
        contentField.removeAttribute('name');
        
        // Update word and character count
        function updateCounts() {
            const text = contentField.innerText;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const chars = text.length;
            
            wordCount.textContent = words;
            charCount.textContent = chars;
            
            // Update hidden field
            hiddenContentField.value = contentField.innerHTML;
        }
        
        // Initialize counts
        updateCounts();
        
        // Update counts on input
        contentField.addEventListener('input', function() {
            updateCounts();
            
            // Auto-save if enabled
            if (autoSaveToggle.checked) {
                autoSave();
            }
        });
        
        // Auto-save function
        let autoSaveTimeout;
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            saveStatus.textContent = 'Saving...';
            
            autoSaveTimeout = setTimeout(function() {
                // In a real app, this would send an AJAX request to save the draft
                saveStatus.textContent = 'Saved';
                setTimeout(function() {
                    saveStatus.textContent = '';
                }, 2000);
            }, 1000);
        }
        
        // Save draft function
        function saveDraft() {
            saveStatus.textContent = 'Saving draft...';
            
            // In a real app, this would send an AJAX request to save the draft
            setTimeout(function() {
                saveStatus.textContent = 'Draft saved';
                setTimeout(function() {
                    saveStatus.textContent = '';
                }, 2000);
            }, 1000);
        }
        
        // Tags functionality
        let tags = [];
        
        function addTag(tag) {
            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                renderTags();
            }
        }
        
        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            renderTags();
        }
        
        function renderTags() {
            tagsList.innerHTML = '';
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'badge bg-secondary me-1 mb-1';
                tagElement.innerHTML = `${tag} <i class="bi bi-x" onclick="removeTag('${tag}')"></i>`;
                tagsList.appendChild(tagElement);
            });
        }
        
        tagsField.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const tag = this.value.trim();
                if (tag) {
                    addTag(tag);
                    this.value = '';
                }
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                document.getElementById('noteForm').submit();
            }
            
            // Formatting shortcuts
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'b':
                        e.preventDefault();
                        formatText('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        formatText('italic');
                        break;
                    case 'u':
                        e.preventDefault();
                        formatText('underline');
                        break;
                }
            }
        });
        
        // Load draft if exists
        const draft = localStorage.getItem('noteDraft');
        if (draft) {
            const draftData = JSON.parse(draft);
            const draftDate = new Date(draftData.timestamp);
            const now = new Date();
            const diffHours = (now - draftDate) / (1000 * 60 * 60);
            
            // Only show draft if it's less than 24 hours old
            if (diffHours < 24) {
                // Only populate if fields are empty
                if (!titleField.value && !contentField.innerText.trim()) {
                    titleField.value = draftData.title;
                    contentField.innerHTML = draftData.content;
                    
                    if (draftData.tags) {
                        tags = draftData.tags;
                        renderTags();
                    }
                    
                    // Update word and character count
                    updateCounts();
                    
                    showToast('Draft restored from ' + draftDate.toLocaleString(), 'info');
                }
            }
        }
        
        // Save draft before form submission
        document.getElementById('noteForm').addEventListener('submit', function() {
            localStorage.setItem('noteDraft', JSON.stringify({
                title: titleField.value,
                content: contentField.innerHTML,
                tags: tags,
                timestamp: new Date().toISOString()
            }));
        });
    });
    
    function formatText(command) {
        document.execCommand(command, false, null);
        document.getElementById('{{ form.content.id_for_label }}').focus();
    }
    
    function insertLink() {
        const url = prompt('Enter URL:');
        if (url) {
            document.execCommand('createLink', false, url);
            document.getElementById('{{ form.content.id_for_label }}').focus();
        }
    }
    
    function showToast(message, type) {
        // Create a toast notification
        const toastContainer = document.querySelector('.toast-container') || createToastContainer();
        
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 3000
        });
        
        toast.show();
        
        // Remove toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(container);
        return container;
    }
</script>

<style>
    .list-group-item {
        padding: 0.5rem 1rem;
    }
    
    kbd {
        padding: 0.2rem 0.4rem;
        font-size: 0.875em;
        color: var(--dark-color);
        background-color: var(--light-color);
        border-radius: 0.25rem;
        box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.25);
    }
    
    .badge i {
        cursor: pointer;
        margin-left: 5px;
    }
</style>
{% endblock %}